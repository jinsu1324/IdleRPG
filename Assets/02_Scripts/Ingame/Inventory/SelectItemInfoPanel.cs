using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class SelectItemInfoPanel : MonoBehaviour
{
    public Item CurrentItem { get; private set; }  // 현재 아이템

    [SerializeField] private Image _itemIcon;           // 아이템 아이콘
    [SerializeField] private Button _equipButton;       // 장착 버튼
    [SerializeField] private Button _unEquipButton;     // 장착 해제 버튼
    [SerializeField] private Button _enhanceButton;     // 강화 버튼

    /// <summary>
    /// Start
    /// </summary>
    private void Start()
    {
        _equipButton.onClick.AddListener(OnClickEquipButton);       
        _unEquipButton.onClick.AddListener(OnClickUnEquipButton);
        _enhanceButton.onClick.AddListener(OnClickEnhanceButton);
    }

    /// <summary>
    /// 초기화 및 열기
    /// </summary>
    public void OpenAndInit(ItemSlot selectedSlot)
    {
        CurrentItem = selectedSlot.CurrentItem;
        UIUpdate();

        gameObject.SetActive(true);
    }

    /// <summary>
    /// UI 업데이트
    /// </summary>
    private void UIUpdate()
    {
        // 현재 아이템이 없으면 전부 다 끄고 리턴
        if (CurrentItem == null) 
        {
            ClearItemIcon();
            ButtonsOFF();

            return;
        }

        // 아이콘 셋팅 및 버튼 켜기
        SetItemIcon();
        ButtonsON();
    }

    /// <summary>
    /// 장착버튼 클릭
    /// </summary>
    public void OnClickEquipButton()
    {
        if (CurrentItem == null)
            return;

        //ItemEquipManager.Instance.Equip(CurrentItem);  // 현재 아이템 장착
        InventoryManager.Instance.GetItemEquipManager(CurrentItem.ItemType).Equip(CurrentItem);
        UIUpdate();
    }

    /// <summary>
    /// 장착 해제 버튼 클릭
    /// </summary>
    public void OnClickUnEquipButton()
    {
        if (CurrentItem == null)
            return;

        //ItemEquipManager.Instance.UnEquip(CurrentItem); // 현재 아이템 장착 해제
        InventoryManager.Instance.GetItemEquipManager(CurrentItem.ItemType).UnEquip(CurrentItem);
        UIUpdate();
    }

    public void OnClickEnhanceButton()
    {
        if (CurrentItem == null)
            return;

        CurrentItem.Enhance();


        UIUpdate(); // 패널 UI 업데이트
    }



    /// <summary>
    /// 아이템 아이콘 셋팅
    /// </summary>
    private void SetItemIcon()
    {
        _itemIcon.sprite = CurrentItem.Icon;
        _itemIcon.gameObject.SetActive(true);
    }

    /// <summary>
    /// 아이템 아이콘 클리어
    /// </summary>
    private void ClearItemIcon()
    {
        _itemIcon = null;
        _itemIcon.gameObject.SetActive(false);
    }

    /// <summary>
    /// 버튼들 켜기
    /// </summary>
    private void ButtonsON()
    {

        //bool isEquipped = ItemEquipManager.Instance.IsEquipped(CurrentItem);
        bool isEquipped = InventoryManager.Instance.GetItemEquipManager(CurrentItem.ItemType).IsEquipped(CurrentItem);

        bool isEnhanceable = CurrentItem.IsEnhanceable();

        _equipButton.gameObject.SetActive(!isEquipped);  // 장착버튼은 장착되어있으면 비활성화
        _unEquipButton.gameObject.SetActive(isEquipped);   // 해제버튼은 '패널 아이템' = '장착된 아이템' 일 때만 활성화
        _enhanceButton.gameObject.SetActive(isEnhanceable); // 강화 가능할때만 활성화

    }

    /// <summary>
    /// 버튼들 끄기
    /// </summary>
    private void ButtonsOFF()
    {
        _equipButton.gameObject.SetActive(false);
        _unEquipButton.gameObject.SetActive(false);
        _enhanceButton.gameObject.SetActive(false);
    }
}
